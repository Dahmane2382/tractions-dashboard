<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tractions ‚Äì Dashboard d‚ÄôAdrien</title>

    <style>
        body {
            font-family: Segoe UI, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 30px;
            color: #222;
        }

        h1 {
            text-align: center;
            margin-bottom: 25px;
        }

        #app {
            max-width: 900px;
            margin: auto;
        }

        .card {
            background: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        input {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 200px;
        }

        #searchBtn {
            margin-top: 10px;
            padding: 10px 15px;
            border: none;
            background: #4a90e2;
            color: white;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        #searchBtn:hover {
            background: #3a78c2;
        }

        #result {
            margin-top: 12px;
            font-size: 18px;
            font-weight: bold;
        }

        img {
            width: 100%;
            border-radius: 12px;
        }
    </style>
</head>
<body>

<h1>Dashboard Tractions Lest√©es ‚Äì A. Pfyffer</h1>

<div id="app">

    <!-- Recherche -->
    <div class="card">
        <h2>üîç Recherche par date</h2>
        <input type="date" id="dateInput">
        <button id="searchBtn">Rechercher</button>
        <div id="result"></div>
    </div>

    <!-- Graph -->
    <div class="card">
        <h2>üìà Graphique</h2>
        <img src="graph.png">
    </div>

    <!-- PR -->
    <div class="card">
        <h2>üèÜ Records Personnels</h2>
        <ul id="pr-list"></ul>
    </div>

    <!-- Stats -->
    <div class="card">
        <h2>üìä Statistiques Globales</h2>
        <ul id="stats-list"></ul>
    </div>

</div>

<!-- ========================= -->
<!--   SCRIPT PRINCIPAL       -->
<!-- ========================= -->
<script>
fetch("data.json?v=" + Date.now())
    .then(r => r.json())
    .then(data => initApp(data));


function initApp(data) {

    // Convertit YYYY-MM-DD ‚Üí DD-MM-YYYY
    function toDDMMYYYY(dateStr) {
        const [year, month, day] = dateStr.split("-");
        return `${day}-${month}-${year}`;
    }

    // Convertit DD-MM-YYYY ‚Üí timestamp utilisable
    function toTimestamp(dstr) {
        const [d, m, y] = dstr.split("-").map(Number);
        return new Date(y, m - 1, d).getTime();
    }

    function afficherDonnees(inputValue) {
        const d = toDDMMYYYY(inputValue);
        const res = document.getElementById("result");

        const dates = Object.keys(data).sort((a, b) => toTimestamp(a) - toTimestamp(b));

        const t = toTimestamp(d);
	const tMin = toTimestamp(dates[0]);
	const tMax = toTimestamp(dates[dates.length - 1]);

	if (t < tMin) {
   		res.innerHTML = "‚õî Date ant√©rieure au d√©but des mesures.";
    		return;
	}

	if (t > tMax) {
    		res.innerHTML = "‚õî Date dans le futur.";
    		return;
	}


        // Cas exact ‚Üí affichage direct
        if (data[d]) {
            const s = data[d];
            res.innerHTML =
                "Poids : " + s.poids + " kg<br>" +
                "Best reps : " + s.best_reps + "<br>" +
                "1RM th√©orique : <b>" + s.rm_lest.toFixed(1) + " kg</b>";
            return;
        }

        // Sinon interpolation
	let dA = null, dB = null;

	for (let i = 0; i < dates.length - 1; i++) {
    		if (toTimestamp(dates[i]) < t &&
    			t < toTimestamp(dates[i+1])) {
        		dA = dates[i];
        		dB = dates[i+1];
        		break;
    		}
	}

	const tA = toTimestamp(dA);
	const tB = toTimestamp(dB);

	const ratio = (t - tA) / (tB - tA);


        const A = data[dA];
        const B = data[dB];

        const poidsI = A.poids + ratio * (B.poids - A.poids);
        const repsI  = A.best_reps + ratio * (B.best_reps - A.best_reps);
        const rmI    = A.rm_lest + ratio * (B.rm_lest - A.rm_lest);

        res.innerHTML =
            "<i>(Valeurs interpol√©es)</i><br>" +
            "Poids estim√© : " + poidsI.toFixed(1) + " kg<br>" +
            "Best reps estim√© : " + repsI.toFixed(1) + "<br>" +
            "1RM estim√© : <b>" + rmI.toFixed(1) + " kg</b>";
    }


    document.getElementById("searchBtn").onclick = () => {
        afficherDonnees(document.getElementById("dateInput").value);
    };

    document.getElementById("dateInput").addEventListener("keydown", e => {
        if (e.key === "Enter") afficherDonnees(e.target.value);
    });

    // ---------- PR ----------
    let pr1rm = -Infinity;
    let pr1rm_date = "";
    let pr_weight = -Infinity;
    let pr_weight_date = "";

    for (let d in data) {
        if (data[d].rm_lest > pr1rm) {
            pr1rm = data[d].rm_lest;
            pr1rm_date = d;
        }
        if (data[d].poids > pr_weight) {
            pr_weight = data[d].poids;
            pr_weight_date = d;
        }
    }

    document.getElementById("pr-list").innerHTML = `
        <li><b>1RM max :</b> ${pr1rm.toFixed(1)} kg (${pr1rm_date})</li>
        <li><b>Poids lest√© max :</b> ${pr_weight} kg (${pr_weight_date})</li>
    `;


    // ---------- Stats ----------
    const dates = Object.keys(data);
    const total = dates.length;

    let avg_reps = 0, avg_rm = 0;

    for (let d of dates) {
        avg_reps += data[d].best_reps;
        avg_rm += data[d].rm_lest;
    }

    avg_reps /= total;
    avg_rm /= total;

    document.getElementById("stats-list").innerHTML = `
        <li>Nombre total de s√©ances : ${total}</li>
        <li>Moyenne best reps : ${avg_reps.toFixed(2)}</li>
        <li>Moyenne 1RM th√©orique : ${avg_rm.toFixed(2)} kg</li>
    `;
}
</script>

</body>
</html>
